<html>
    <head>
        <title>Building Permits</title>

        <!-- DataTables + jQuery -->
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.datatables.net/2.3.5/css/dataTables.dataTables.css" />
        <script src="https://cdn.datatables.net/2.3.5/js/dataTables.js"></script>

        <style>
            .header {
                font-weight: bold;
                padding: 20px;
                background-color: beige;
            }

            .details {
                padding: 10px;
                background-color: lightgreen;
            }

            body {
                font-family: Arial, Helvetica, sans-serif;
                font-size: 14pt;
                padding: auto;
            }

            h1 {
                color: green;
            }

            #data-table th {
                padding-top: 12px;
                padding-bottom: 12px;
                text-align: left;
                background-color: lightblue;
                color: black;
            }

            #data-table {
                font-family: Arial, Helvetica, sans-serif;
                border-collapse: collapse;
                width: 100%;
            }

            #data-table td, th {
                border: 1px solid #ddd;
                padding: 8px;
            }
        </style>

        <script>
        // When the webpage loads, call the following code...
        window.onload = (event) => {
            var table = document.getElementById("data-table");

            // Frontend on 9000 â†’ backend on 5001
            // Endpoint path is /api/building
            // Add a bigger page_size so we see more rows at once
            var baseUrl = window.location.origin.replace("9000", "5001");
            var URL = baseUrl + "/api/building?page=1&page_size=200";

            var table_container = document.getElementById("content");
            table_container.style.display = "none";

            // Set up DataTable with real JSON keys
            let data_table = new DataTable("#data-table", {
                order: [[5, "desc"]],  // sort by data_posted_on desc (col index 5 below)
                processing: true,
                columns: [
                    {
                        data: "id",
                        defaultContent: "N/A",
                        type: "num"
                    },
                    {
                        data: "neighborhood",
                        defaultContent: "N/A",
                        type: "string-utf8"
                    },
                    {
                        data: "total_permits",
                        defaultContent: "N/A",
                        type: "num"
                    },
                    {
                        data: "total_value",
                        defaultContent: "N/A",
                        type: "num-fmt",
                        // display currency with $
                        render: function (val, type, row) {
                            if (val == null) return "N/A";
                            return DataTable.render.number(null, null, 2, '$')(val, type, row);
                        }
                    },
                    {
                        data: "avg_days_to_issue",
                        defaultContent: "N/A",
                        type: "num"
                    },
                    {
                        data: "data_posted_on",
                        defaultContent: "N/A",
                        type: "date"
                    },
                    {
                        data: "created_on",
                        defaultContent: "N/A",
                        type: "date"
                    },
                    {
                        data: "is_active",
                        defaultContent: "N/A",
                        render: function (val, type, row) {
                            if (val === true || val === 1 || val === "1") return "Active";
                            if (val === false || val === 0 || val === "0") return "Inactive";
                            return String(val);
                        }
                    }
                ]
            });

            const xmlhttp = new XMLHttpRequest();
            xmlhttp.onload = function() {
                try {
                    document.getElementById("status-text").innerHTML = "<b>Loading table...</b>";

                    var raw = JSON.parse(this.responseText);
                    // unwrap pagination envelope
                    var rows = raw.results || [];
                    var page = raw.page || 1;
                    var page_size = raw.page_size || rows.length;
                    var total = raw.total || rows.length;
                    var total_pages = page_size > 0 ? Math.ceil(total / page_size) : 1;

                    for (let i = 0; i < rows.length; i++) {
                        var entity = rows[i];

                        // These keys match your Python mapping exactly
                        data_table.row.add({
                            id: entity["id"],
                            neighborhood: entity["neighborhood"],
                            total_permits: entity["total_permits"],
                            total_value: entity["total_value"],
                            avg_days_to_issue: entity["avg_days_to_issue"],
                            data_posted_on: entity["data_posted_on"],
                            created_on: entity["created_on"],
                            is_active: entity["is_active"]
                        });

                        console.log(
                            "Added building permit row " +
                            String(entity["id"]) +
                            " (" + String(entity["neighborhood"]) + ")"
                        );
                    }

                    data_table.columns.adjust().draw();
                    table_container.style.display = "block";

                    document.getElementById("status-text").innerHTML =
                        "<b>Showing " + rows.length + " active building-permit summary rows (page " +
                        page + " of " + total_pages + ", total " + total + ").</b>";
                } catch (error) {
                    alert("Something went wrong when processing the data!\n" + String(error));
                }
            };

            try {
                xmlhttp.open("GET", URL);
                xmlhttp.send();
            } catch (error) {
                alert("Something went wrong when connecting to the back-end!\n" + String(error));
            }
        };

    </script>
    </head>
    <body>
        <h1>Building Permits by Neighborhood</h1>
        <br>
        <div>
            <div class="header">Results<br></div>
                <br>
                <a href="index.htm">Return to home page</a>
                <br>
                <div style="text-align: center;" id="status-text"><b>Loading data and table...</b></div>
                <br><br>
                <div id="content">
                    <table class="display" id="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Neighborhood</th>
                                <th>Total Permits</th>
                                <th>Total Value</th>
                                <th>Avg Days to Issue</th>
                                <th>Date Posted</th>
                                <th>Row Created</th>
                                <th>Active?</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                <br><br>
            </div>
        </div>
        <br>
        <br>
        <br>
        <br>

        <footer>
            <hr>
            <p>
                <span id="year"></span> SLU Open Source <br>
                <script>document.getElementById("year").innerHTML = new Date().getFullYear();</script>
            </p>
        </footer>
    </body>
</html>
