# Docker Validation: build and smoke-test images (no push)
# Triggers on pushes to main/develop, PRs to main, and manual dispatch.
name: Docker Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Dynamic tag to avoid overwrites and allow easy tracing
  IMAGE_TAG: ${{ github.sha }}-${{ github.run_number }}
  IMAGE_REPO_PREFIX: stl-metro  # local tag prefix, not pushed to remote

jobs:
  build-and-smoke:
    name: Build and Smoke-test Docker images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for cross-platform builds)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build write_service image (load into local daemon for smoke test)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/write_service/Dockerfile
          push: false
          load: true           # <-- ensure image is available to `docker run` on the runner
          tags: ${{ env.IMAGE_REPO_PREFIX }}/write_service:${{ env.IMAGE_TAG }}
          # platform: linux/amd64  # optionally add if you need a specific platform

      - name: Build read_service image (load into local daemon for smoke test)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/read_service/Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_REPO_PREFIX }}/read_service:${{ env.IMAGE_TAG }}

      - name: List built images
        run: docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}"

      - name: Smoke test write_service
        # If container has Python, this will print OK. If not, fallback to sh echo.
        run: |
          if docker run --rm ${{ env.IMAGE_REPO_PREFIX }}/write_service:${{ env.IMAGE_TAG }} python -c "print('OK')"; then
            echo "write_service smoke test passed with python run"
          else
            echo "python not available, trying sh fallback"
            docker run --rm --entrypoint sh ${{ env.IMAGE_REPO_PREFIX }}/write_service:${{ env.IMAGE_TAG }} -c 'echo OK'
          fi

      - name: Smoke test read_service
        run: |
          if docker run --rm ${{ env.IMAGE_REPO_PREFIX }}/read_service:${{ env.IMAGE_TAG }} python -c "print('OK')"; then
            echo "read_service smoke test passed with python run"
          else
            echo "python not available, trying sh fallback"
            docker run --rm --entrypoint sh ${{ env.IMAGE_REPO_PREFIX }}/read_service:${{ env.IMAGE_TAG }} -c 'echo OK'
          fi